<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 780" font-family="Inter, -apple-system, sans-serif" font-size="13">
  <defs>
    <style>
      .title { font-size: 20px; font-weight: 700; fill: #1a1a2e; }
      .subtitle { font-size: 12px; fill: #666; }
      .box { rx: 8; ry: 8; stroke-width: 2; }
      .box-label { font-size: 14px; font-weight: 600; }
      .box-detail { font-size: 11px; fill: #555; }
      .box-port { font-size: 10px; fill: #888; font-family: monospace; }
      .env-box { fill: #f0f4ff; stroke: #4a6cf7; }
      .compute-box { fill: #e8f5e9; stroke: #43a047; }
      .db-box { fill: #fff3e0; stroke: #ef6c00; }
      .service-box { fill: #fff; stroke: #999; stroke-width: 1.5; }
      .external-box { fill: #f3e5f5; stroke: #7b1fa2; }
      .state-box { fill: #e3f2fd; stroke: #1565c0; }
      .docker-box { fill: #e8f4fd; stroke: #2196f3; stroke-dasharray: 6,3; }
      .arrow { stroke: #555; stroke-width: 1.5; fill: none; marker-end: url(#arrowhead); }
      .arrow-mqtt { stroke: #e65100; stroke-width: 2; fill: none; marker-end: url(#arrowhead-mqtt); }
      .arrow-sql { stroke: #1565c0; stroke-width: 2; fill: none; marker-end: url(#arrowhead-sql); }
      .arrow-http { stroke: #43a047; stroke-width: 2; fill: none; marker-end: url(#arrowhead-http); }
      .arrow-internal { stroke: #999; stroke-width: 1.5; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 4,3; }
      .legend-text { font-size: 11px; fill: #444; }
    </style>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#555"/>
    </marker>
    <marker id="arrowhead-mqtt" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#e65100"/>
    </marker>
    <marker id="arrowhead-sql" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#1565c0"/>
    </marker>
    <marker id="arrowhead-http" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#43a047"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="550" y="35" text-anchor="middle" class="title">AccoReboot — Architecture de deploiement</text>
  <text x="550" y="55" text-anchor="middle" class="subtitle">1 projet OVH Public Cloud par environnement (test / preprod / prod) — Acces IP only, HTTP :80</text>

  <!-- ============================================ -->
  <!-- External actors -->
  <!-- ============================================ -->

  <!-- GPS Trackers -->
  <rect x="30" y="170" width="140" height="65" class="box external-box"/>
  <text x="100" y="198" text-anchor="middle" class="box-label" fill="#7b1fa2">Traceurs GPS</text>
  <text x="100" y="218" text-anchor="middle" class="box-detail">IoT / vehicules</text>

  <!-- Mobile / Web clients -->
  <rect x="30" y="310" width="140" height="65" class="box external-box"/>
  <text x="100" y="335" text-anchor="middle" class="box-label" fill="#7b1fa2">Clients</text>
  <text x="100" y="355" text-anchor="middle" class="box-detail">Mobile (Flutter)</text>

  <!-- Dev / Ops -->
  <rect x="30" y="450" width="140" height="65" class="box external-box"/>
  <text x="100" y="478" text-anchor="middle" class="box-label" fill="#7b1fa2">Dev / Ops</text>
  <text x="100" y="498" text-anchor="middle" class="box-detail">make up ENV=test</text>

  <!-- ============================================ -->
  <!-- OVH Project boundary -->
  <!-- ============================================ -->
  <rect x="220" y="80" width="850" height="530" class="box env-box"/>
  <text x="645" y="105" text-anchor="middle" class="box-label" fill="#4a6cf7">Projet OVH Public Cloud</text>

  <!-- ============================================ -->
  <!-- Compute Instance -->
  <!-- ============================================ -->
  <rect x="250" y="125" width="530" height="465" class="box compute-box"/>
  <text x="515" y="150" text-anchor="middle" class="box-label" fill="#43a047">Instance Compute b3-8</text>
  <text x="515" y="167" text-anchor="middle" class="box-detail">Ubuntu 24.04 — Docker via cloud-init — /opt/accoreboot</text>

  <!-- Docker Compose boundary -->
  <rect x="270" y="180" width="490" height="390" class="docker-box"/>
  <text x="515" y="200" text-anchor="middle" class="box-detail" fill="#2196f3">docker compose (4 containers)</text>

  <!-- Caddy -->
  <rect x="295" y="215" width="220" height="60" class="box service-box"/>
  <text x="405" y="238" text-anchor="middle" class="box-label">Caddy</text>
  <text x="405" y="256" text-anchor="middle" class="box-detail">Reverse proxy</text>
  <text x="405" y="270" text-anchor="middle" class="box-port">:80  :443</text>

  <!-- API NestJS -->
  <rect x="295" y="295" width="220" height="70" class="box service-box"/>
  <text x="405" y="318" text-anchor="middle" class="box-label">API NestJS</text>
  <text x="405" y="336" text-anchor="middle" class="box-detail">REST + MQTT auth/ACL + JWKS</text>
  <text x="405" y="356" text-anchor="middle" class="box-port">127.0.0.1:3000 (prive Docker Hub)</text>

  <!-- EMQX -->
  <rect x="295" y="385" width="220" height="70" class="box service-box"/>
  <text x="405" y="408" text-anchor="middle" class="box-label">EMQX 5.8</text>
  <text x="405" y="426" text-anchor="middle" class="box-detail">Broker MQTT</text>
  <text x="405" y="446" text-anchor="middle" class="box-port">:1883 (MQTT)  :8083 (WS)</text>

  <!-- PowerSync -->
  <rect x="295" y="475" width="220" height="70" class="box service-box"/>
  <text x="405" y="498" text-anchor="middle" class="box-label">PowerSync</text>
  <text x="405" y="516" text-anchor="middle" class="box-detail">Sync offline-first</text>
  <text x="405" y="536" text-anchor="middle" class="box-port">127.0.0.1:8080 (replication PG)</text>

  <!-- JWT Keys box -->
  <rect x="545" y="295" width="195" height="60" class="box service-box"/>
  <text x="642" y="318" text-anchor="middle" class="box-label">JWT RS256</text>
  <text x="642" y="338" text-anchor="middle" class="box-detail">keys/private.pem + public.pem</text>
  <text x="642" y="350" text-anchor="middle" class="box-detail">(genere par Ansible, idempotent)</text>

  <!-- Makefile on instance -->
  <rect x="545" y="215" width="195" height="55" class="box service-box"/>
  <text x="642" y="238" text-anchor="middle" class="box-label">Makefile</text>
  <text x="642" y="256" text-anchor="middle" class="box-detail">make up / down / logs / ps</text>

  <!-- ============================================ -->
  <!-- Managed PostgreSQL -->
  <!-- ============================================ -->
  <rect x="830" y="180" width="220" height="170" class="box db-box"/>
  <text x="940" y="208" text-anchor="middle" class="box-label" fill="#ef6c00">PostgreSQL manage</text>
  <text x="940" y="228" text-anchor="middle" class="box-detail">OVH db1-4 — PG17</text>
  <text x="940" y="248" text-anchor="middle" class="box-detail">+ TimescaleDB</text>
  <text x="940" y="275" text-anchor="middle" class="box-port">sslmode=require</text>

  <!-- DB: accoreboot -->
  <rect x="850" y="288" width="80" height="25" rx="4" ry="4" fill="#fff3e0" stroke="#ef6c00" stroke-width="1"/>
  <text x="890" y="305" text-anchor="middle" class="box-detail">accoreboot</text>

  <!-- DB: powersync_storage -->
  <rect x="950" y="288" width="85" height="25" rx="4" ry="4" fill="#fff3e0" stroke="#ef6c00" stroke-width="1"/>
  <text x="992" y="305" text-anchor="middle" class="box-detail" font-size="10">powersync_storage</text>

  <text x="940" y="340" text-anchor="middle" class="box-detail">Utilisateur: accoreboot</text>

  <!-- S3 State -->
  <rect x="830" y="390" width="220" height="70" class="box state-box"/>
  <text x="940" y="418" text-anchor="middle" class="box-label" fill="#1565c0">OVH Object Storage</text>
  <text x="940" y="438" text-anchor="middle" class="box-detail">accoreboot-tfstate (S3)</text>
  <text x="940" y="452" text-anchor="middle" class="box-port">Terraform state (chiffre au repos)</text>

  <!-- ============================================ -->
  <!-- Arrows: External → Instance -->
  <!-- ============================================ -->

  <!-- GPS → EMQX (MQTT) -->
  <path d="M 170,200 L 290,415" class="arrow-mqtt"/>
  <text x="205" y="290" class="legend-text" fill="#e65100" transform="rotate(-40, 205, 290)">MQTT :1883</text>

  <!-- Clients → Caddy (HTTP) -->
  <path d="M 170,335 L 290,245" class="arrow-http"/>
  <text x="210" y="270" class="legend-text" fill="#43a047">HTTP :80</text>

  <!-- Dev → Instance (SSH/Ansible) -->
  <path d="M 170,480 L 250,480" class="arrow"/>
  <text x="200" y="472" class="legend-text">SSH</text>

  <!-- ============================================ -->
  <!-- Arrows: Internal (Caddy → services) -->
  <!-- ============================================ -->

  <!-- Caddy → API -->
  <path d="M 405,275 L 405,290" class="arrow-internal"/>

  <!-- Caddy routes label -->
  <text x="540" y="384" text-anchor="start" class="box-detail" fill="#999">/api/* /health</text>
  <text x="540" y="397" text-anchor="start" class="box-detail" fill="#999">/.well-known/*</text>

  <!-- Caddy → PowerSync -->
  <path d="M 340,275 L 340,470" class="arrow-internal"/>
  <text x="540" y="410" text-anchor="start" class="box-detail" fill="#999">/powersync/*</text>

  <!-- Caddy → EMQX WS -->
  <text x="540" y="423" text-anchor="start" class="box-detail" fill="#999">/mqtt (WS)</text>

  <!-- EMQX → API (auth/acl) -->
  <path d="M 405,385 L 405,370" class="arrow-internal"/>
  <text x="420" y="380" class="box-detail" fill="#999">auth/acl</text>

  <!-- ============================================ -->
  <!-- Arrows: Services → PostgreSQL -->
  <!-- ============================================ -->

  <!-- API → PG -->
  <path d="M 515,330 L 825,250" class="arrow-sql"/>
  <text x="680" y="275" class="legend-text" fill="#1565c0">SQL (ssl)</text>

  <!-- PowerSync → PG -->
  <path d="M 515,510 L 825,290" class="arrow-sql"/>

  <!-- ============================================ -->
  <!-- IaC footer -->
  <!-- ============================================ -->
  <rect x="30" y="630" width="1040" height="100" rx="8" ry="8" fill="#f9f9f9" stroke="#ccc" stroke-width="1.5" stroke-dasharray="8,4"/>
  <text x="550" y="655" text-anchor="middle" class="box-label" fill="#666">Infrastructure as Code</text>

  <!-- Terraform -->
  <rect x="60" y="665" width="190" height="48" class="box service-box"/>
  <text x="155" y="685" text-anchor="middle" class="box-label">Terraform</text>
  <text x="155" y="702" text-anchor="middle" class="box-detail">Provisioning OVH + cloud-init</text>

  <!-- Ansible -->
  <rect x="280" y="665" width="190" height="48" class="box service-box"/>
  <text x="375" y="685" text-anchor="middle" class="box-label">Ansible</text>
  <text x="375" y="702" text-anchor="middle" class="box-detail">site.yml → templates → compose</text>

  <!-- SOPS -->
  <rect x="500" y="665" width="190" height="48" class="box service-box"/>
  <text x="595" y="685" text-anchor="middle" class="box-label">SOPS + age</text>
  <text x="595" y="702" text-anchor="middle" class="box-detail">Secrets chiffres dans Git</text>

  <!-- Makefile -->
  <rect x="720" y="665" width="190" height="48" class="box service-box"/>
  <text x="815" y="685" text-anchor="middle" class="box-label">Makefile</text>
  <text x="815" y="702" text-anchor="middle" class="box-detail">make up ENV=test (facade)</text>

  <!-- Docker Hub -->
  <rect x="940" y="665" width="110" height="48" class="box external-box"/>
  <text x="995" y="685" text-anchor="middle" class="box-label" fill="#7b1fa2">Docker Hub</text>
  <text x="995" y="702" text-anchor="middle" class="box-detail">API image (prive)</text>

  <!-- ============================================ -->
  <!-- Legend -->
  <!-- ============================================ -->
  <rect x="30" y="745" width="1040" height="28" rx="4" ry="4" fill="none"/>
  <line x1="50" y1="760" x2="80" y2="760" class="arrow-mqtt" stroke-width="2"/>
  <text x="85" y="764" class="legend-text">MQTT</text>
  <line x1="145" y1="760" x2="175" y2="760" class="arrow-http" stroke-width="2"/>
  <text x="180" y="764" class="legend-text">HTTP</text>
  <line x1="230" y1="760" x2="260" y2="760" class="arrow-sql" stroke-width="2"/>
  <text x="265" y="764" class="legend-text">SQL (ssl)</text>
  <line x1="330" y1="760" x2="360" y2="760" class="arrow-internal"/>
  <text x="365" y="764" class="legend-text">Interne</text>
  <rect x="430" y="752" width="16" height="16" rx="3" ry="3" fill="#f0f4ff" stroke="#4a6cf7" stroke-width="1.5"/>
  <text x="452" y="764" class="legend-text">Projet OVH</text>
  <rect x="540" y="752" width="16" height="16" rx="3" ry="3" fill="#e8f5e9" stroke="#43a047" stroke-width="1.5"/>
  <text x="562" y="764" class="legend-text">Compute</text>
  <rect x="630" y="752" width="16" height="16" rx="3" ry="3" fill="#fff3e0" stroke="#ef6c00" stroke-width="1.5"/>
  <text x="652" y="764" class="legend-text">DB Managee</text>
  <rect x="740" y="752" width="16" height="16" rx="3" ry="3" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="1.5"/>
  <text x="762" y="764" class="legend-text">Externe</text>
  <rect x="820" y="752" width="16" height="16" rx="3" ry="3" fill="#e8f4fd" stroke="#2196f3" stroke-width="1.5" stroke-dasharray="3,2"/>
  <text x="842" y="764" class="legend-text">Docker Compose</text>
</svg>
