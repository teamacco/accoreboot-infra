# PowerSync Sync Rules
# Auto-generated by Ansible â€” do not edit manually
#
# PostGIS Integration:
# PowerSync ne supporte PAS directement ST_X/ST_Y sur les colonnes GEOMETRY.
# Solution: stocker latitude/longitude comme colonnes separees + location GEOMETRY generee.
# Le mobile ecrit lat/lng, PostgreSQL genere la geometry pour requetes spatiales.

bucket_definitions:
  # Organisation-wide data bucket
  organisation:
    parameters: SELECT request.jwt() ->> 'organisation_id' AS org_id
    data:
      # Organisation info
      - SELECT id, name, created_at, updated_at
        FROM organisations
        WHERE id = bucket.org_id

      # All users in the organisation
      - SELECT id, email, name, organisation_id, created_at, updated_at
        FROM users
        WHERE organisation_id = bucket.org_id

      # All chantiers of the organisation
      - SELECT id, organisation_id, name, description, status,
               created_at, updated_at
        FROM chantiers
        WHERE organisation_id = bucket.org_id

      # Chantier assignments
      - SELECT id, chantier_id, user_id, organisation_id, role, created_at
        FROM chantier_users
        WHERE organisation_id = bucket.org_id

      # Constatations
      - SELECT id, chantier_id, user_id, organisation_id,
               title, description, status, photo_url,
               latitude, longitude,
               created_at, updated_at
        FROM constatations
        WHERE organisation_id = bucket.org_id

      # Tasks (last 90 days)
      - SELECT id, chantier_id, user_id, organisation_id,
               started_at, ended_at, status, point_count, distance_meters,
               geometry_geojson,
               created_at, updated_at
        FROM tasks
        WHERE organisation_id = bucket.org_id
          AND created_at > NOW() - INTERVAL '90 days'
