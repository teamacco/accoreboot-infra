services:
  # ===========================================
  # Backend API (NestJS)
  # ===========================================
  api:
    image: {{ api_image }}:{{ api_tag }}
    container_name: {{ app_name }}-api
    restart: unless-stopped
    ports:
      - "127.0.0.1:{{ api_port }}:{{ api_port }}"
    env_file:
      - .env
    volumes:
      - ./keys:/app/keys:ro
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:{{ api_port }}/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================
  # EMQX MQTT Broker
  # ===========================================
  emqx:
    image: {{ emqx_image }}
    container_name: {{ app_name }}-emqx
    restart: unless-stopped
    ports:
      - "{{ emqx_mqtt_port }}:1883"
      - "{{ emqx_ws_port }}:8083"
{% if emqx_dashboard_port_exposed | default(false) %}
      - "18083:18083"
{% endif %}
    environment:
      EMQX_NAME: {{ app_name }}-emqx
      EMQX_HOST: emqx
      EMQX_ALLOW_ANONYMOUS: "false"
      EMQX_DASHBOARD__DEFAULT_USERNAME: admin
      EMQX_DASHBOARD__DEFAULT_PASSWORD: "{{ emqx_dashboard_password }}"
    volumes:
      - emqx_data:/opt/emqx/data
      - ./emqx/emqx.conf:/opt/emqx/data/configs/cluster.hocon:ro
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:18083/status || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================
  # PowerSync Service
  # ===========================================
  powersync:
    image: {{ powersync_image }}
    container_name: {{ app_name }}-powersync
    restart: unless-stopped
    ports:
      - "127.0.0.1:{{ powersync_port }}:{{ powersync_port }}"
    command: ["start", "-c", "/config/powersync.yaml"]
    env_file:
      - .env
    volumes:
      - ./powersync:/config:ro
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:{{ powersync_port }}/api/status || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===========================================
  # Caddy Reverse Proxy
  # ===========================================
  caddy:
    image: {{ caddy_image }}
    container_name: {{ app_name }}-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      api:
        condition: service_healthy

volumes:
  emqx_data:
  caddy_data:
  caddy_config:
